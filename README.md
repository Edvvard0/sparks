# Sparks

Sparks — Telegram Mini App про отношения и «искры» между людьми: приложение выдаёт короткие задания (карточки), помогает поддерживать регулярные тёплые действия, показывает прогресс и баланс «искр», а также даёт возможность докупать дополнительные задания.

## Что внутри

Проект состоит из нескольких частей:

- **Frontend** (`frontend/`): React + TypeScript + Tailwind CSS. UI приложения (карточки заданий, модалки, профиль, настройки, покупки).
- **Backend API** (`backend/`): FastAPI + SQLAlchemy + SQLite + Alembic. Бизнес‑логика, выдача заданий, бонусы, баланс, операции с кошельком.
- **Admin** (`admin/`): Django Admin для управления данными (пользователи, баланс, задания, категории, переводы и т.д.).
- **Nginx** (`nginx/`): reverse proxy для фронта, API и админки (и SSL через certbot в проде).
- **Telegram Bot** (`backend/app/bot.py`): сообщение `/start` и кнопка для открытия Mini App.

## Основные сценарии

- **Онбординг**: пользователь выбирает формат аккаунта/интересы (направления), далее попадает в основной экран.
- **Карточки заданий**: задания отображаются каруселью, можно листать назад/вперёд. Текст задания — без заголовка, крупно, с логотипом снизу.
- **Ограничение выдачи**: есть дневной лимит бесплатных заданий + количество купленных (paid_available). После просмотра всех доступных задач показывается **offer‑карточка** (экран покупки).
- **Баланс и покупки**: баланс «искр» хранится на сервере. Покупка дополнительных заданий увеличивает доступные карточки и вставляет новые задания перед offer‑карточкой.
- **DailyBonus**: отдельная модалка с бонусом дня и переводами.
- **Настройки**: модалки с корректным скроллом, скрывают нижнее меню.
- **Профиль**: отображает баланс, интересы (с лимитом), кнопку TON Connect, кнопку Disconnect.

## Технологии

### Frontend

- **React + TypeScript**
- **Tailwind CSS**
- **react-i18next** (локализация)
- **@react-spring/web** (анимации карусели карточек)
- **Telegram WebApp SDK** (полноэкранный запуск, интеграция с Telegram окружением)

### Backend

- **FastAPI**
- **SQLAlchemy**
- **SQLite**
- **Alembic** (миграции)

### Admin

- **Django 4.x**
- **Django Admin**
- Тесты админки на базе `TestCase`

### Infra

- **Docker / Docker Compose**
- **Nginx**
- **Certbot** (в проде)

## TON: как используется и почему так

В проекте TON используется для **привязки кошелька к существующему профилю** (а не для создания нового пользователя).

- На фронте используется **TON Connect UI** и **TON Proof**.
- Бэкенд проверяет proof и **ищет пользователя по `tg_id`** (из заголовка `X-Telegram-User-ID`), после чего **обновляет `wallet_address`** в профиле.
- Если пользователя нет — бэкенд **не регистрирует** автоматически нового (чтобы не плодить дубликаты).
- Для отвязки реализован отдельный эндпоинт **`PATCH /auth/wallet/disconnect`**.

Идея: Telegram ID — источник истины для идентификации пользователя; кошелёк — лишь атрибут профиля.

## Запуск в Docker (локально/сервер)

Из корня проекта:

```bash
docker compose up -d --build
docker compose ps
```

Логи:

```bash
docker compose logs -f backend
docker compose logs -f frontend
docker compose logs -f admin
docker compose logs -f nginx
```


## Структура репозитория

```text
.
├─ backend/          # FastAPI, SQLAlchemy, Alembic, bot
├─ frontend/         # React/Vite, Tailwind, i18n, UI
├─ admin/            # Django Admin
├─ nginx/            # Nginx конфиги
├─ scripts/          # деплой/утилиты (если используются)
├─ docker-compose.yml
└─ README.md
```

## Лицензия / доступ

Внутренний проект. Не публикуйте `.env` и любые ключи/токены в репозиторий.


