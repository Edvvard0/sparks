# Тестирование админки Django

## Описание

Набор тестов для полного покрытия функционала админки Django приложения Sparks.

## Запуск тестов

### Локально

```bash
cd admin
python manage.py test apps.admin_app.tests
```

### Все тесты

```bash
python manage.py test
```

### Конкретный тест-класс

```bash
python manage.py test apps.admin_app.tests.TaskCategoryAdminTest
```

### Конкретный тест

```bash
python manage.py test apps.admin_app.tests.TaskCategoryAdminTest.test_category_create_with_translations
```

### С подробным выводом

```bash
python manage.py test apps.admin_app.tests --verbosity=2
```

### В Docker контейнере

```bash
docker compose exec admin python manage.py test apps.admin_app.tests
```

## Структура тестов

### 1. LanguageAdminTest
- Отображение списка языков
- Добавление нового языка
- Создание языка через админку
- Действия активации/деактивации языков

### 2. UserAdminTest
- Отображение списка пользователей
- Добавление нового пользователя
- Создание пользователя через админку

### 3. TaskCategoryAdminTest (КРИТИЧНО)
- Отображение списка категорий
- Добавление новой категории
- Создание категории без переводов
- **Создание категории с переводами** (проверка исправления бага)
- Редактирование категории с переводами
- Действия активации/деактивации категорий

### 4. TaskAdminTest
- Отображение списка задач
- Добавление новой задачи
- Создание задачи без переводов
- Создание задачи с переводами и гендерными целями
- Действия активации/деактивации задач

### 5. CompletedTaskAdminTest
- Отображение списка выполненных задач

### 6. DailyFreeTaskAdminTest
- Отображение списка ежедневных бесплатных задач

### 7. DailyBonusAdminTest
- Отображение списка ежедневных бонусов

### 8. TransactionAdminTest
- Отображение списка транзакций

### 9. AdminIntegrationTest
- Полный цикл работы с категорией (создание, редактирование)
- Полный цикл работы с задачей (создание с переводами и гендерными целями)

## Критичные тесты

Особое внимание уделено тестам для `TaskCategoryAdmin`, так как там была проблема с сохранением категорий с переводами:

- `test_category_create_with_translations` - проверяет создание категории с несколькими переводами
- `test_category_edit_with_translations` - проверяет редактирование категории с переводами

Эти тесты проверяют, что:
1. Категория создается с правильным ID
2. Переводы сохраняются с правильным `category_id`
3. Нет ошибок типа "save() prohibited to prevent data loss due to unsaved related object"

## Примечания

- Тесты используют SQLite базу данных (настроена в `settings.py` для тестов)
- Все тесты создают необходимые данные через SQL запросы, так как модели имеют `managed = False`
- Тесты проверяют как UI админки (через Client), так и логику сохранения (через прямые запросы к БД)

## Покрытие функционала

Тесты покрывают:
- ✅ Создание всех основных моделей через админку
- ✅ Редактирование моделей
- ✅ Действия (actions) в админке
- ✅ Inline формы (CategoryTranslation, TaskTranslation, TaskGenderTarget)
- ✅ Кастомные методы сохранения (save_model, save_formset, save_related)
- ✅ Генерация ID для новых объектов
- ✅ Валидация обязательных полей

## Добавление новых тестов

При добавлении нового функционала в админку:

1. Создайте новый тест-класс, наследуясь от `AdminTestCase`
2. Добавьте методы `setUp()` если нужны дополнительные данные
3. Напишите тесты для каждого нового метода/действия
4. Запустите тесты и убедитесь что они проходят

Пример:

```python
class MyNewAdminTest(AdminTestCase):
    def test_my_new_feature(self):
        # Ваш тест
        pass
```

